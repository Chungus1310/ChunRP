/* Enhanced Mobile Responsive Styles for ChunRP */

/* Modern Mobile Variables */
:root {
  --mobile-sidebar-width: 320px;
  --mobile-header-height: 70px;
  --mobile-footer-height: 70px;
  --mobile-transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Removed legacy mobile menu toggle & nav footer default hides */

/* Enhanced Edit Mode for Mobile */
@media screen and (max-width: 1024px) {
  .edit-textarea {
    min-width: 0;
    width: 96%;
    max-width: 96%;
    min-height: 80px;
    font-size: 1rem;
    padding: var(--spacing-md);
    border-radius: var(--radius-lg);
    border: 2px solid var(--border-color);
    background: var(--input-bg);
    color: var(--text-color);
    resize: vertical;
    box-sizing: border-box;
    margin-bottom: var(--spacing-md);
    transition: all var(--transition-fast);
    backdrop-filter: blur(var(--blur-glass));
    box-shadow: var(--shadow-soft);
  }
  
  .edit-textarea:focus {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-glow);
  }
  
  .edit-actions {
    flex-direction: row;
    gap: var(--spacing-md);
    justify-content: flex-end;
  }
  
  /* Adjust sidebar width for larger tablets */
  .sidebar {
    width: 280px;
  }
  
  /* Make messages wider on tablets for better screen utilization */
  .message {
    max-width: 92% !important;
  }
}

@media screen and (max-width: 480px) {
  .edit-textarea {
    width: 98%;
    max-width: 98%;
    min-height: 70px;
    padding: var(--spacing-sm);
    font-size: 0.95rem;
  }
}

/* Enhanced Tablet Styles - Applied at 768px and below */
/* Base style for mobile-only elements */
.mobile-only {
  display: none;
}
@media screen and (max-width: 768px) {
  /* --- FIX: Reset desktop container styles for mobile --- */
  .app-container {
    /* 1. Remove the 320px padding inherited from desktop styles. This is the main fix. */
    padding-left: 0;
    /* 2. Revert display mode as mobile doesn't use the side-by-side flex layout. */
    display: block;
    /* Use dvh by default, the JS will provide a fallback */
    min-height: 100dvh;
    min-height: var(--app-height, 100dvh); /* Fallback for JS */
  }

  /* --- NEW MOBILE VIEW SYSTEM --- */
  /* By default, show the character list (sidebar) and hide the chat */
  .sidebar {
    /* 3. Override 'position: absolute' from desktop styles to ensure correct flow. */
    position: relative;
    width: 100%;
    /* Use a fixed height of the dynamic viewport */
    height: 100dvh;
    height: var(--app-height, 100dvh); /* JS fallback */
    border-right: none;
    /* Configure as a vertical flex container */
    display: flex;
    flex-direction: column;
    /* Do not scroll the sidebar itself; the inner list will scroll */
    overflow: hidden;
    z-index: 10;
  }

  .main-content {
    display: none;
  }

  /* When a chat is active, hide the sidebar and show the chat content */
  body.mobile-chat-active .sidebar {
    display: none;
  }

  body.mobile-chat-active .main-content {
    display: flex;
    width: 100%;
    /* Use dvh for the outer container */
    height: 100dvh;
    height: var(--app-height, 100dvh); /* Fallback for JS */
  }

  /* Hide desktop-only elements */
  #desktop-sidebar-toggle,
  #mobile-menu-toggle {
    display: none;
  }

  /* Redesign sidebar header to be the main app header */
  .sidebar-header {
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
  }

  /* Redesign chat header for mobile */
  .chat-header {
    padding: var(--spacing-sm) var(--spacing-md);
  }

  .chat-header .character-info {
    flex-grow: 1;
    min-width: 0; /* Allow shrinking */
  }

  .chat-header #character-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .mobile-only {
    display: flex;
  }

  /* Remove the old, non-functional pseudo-element back button */
  .chat-header .character-info::before {
    display: none;
  }

  /* --- NEW FIXED CHAT INPUT --- */
  .chat-container { position: relative; height: auto; }

  .chat-messages {
    padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
  }

  .chat-input-container {
    position: sticky;
    bottom: 0;
    z-index: 30;
    background-color: var(--sidebar-bg);
    border-top: 1px solid var(--border-color);
    padding: var(--spacing-sm) var(--spacing-sm) calc(var(--spacing-sm) + env(safe-area-inset-bottom, 0px));
    box-shadow: 0 -2px 16px rgba(0,0,0,0.1);
    will-change: transform, padding-bottom;
  }

  .chat-input-area {
    display: flex;
    align-items: flex-end;
    gap: var(--spacing-xs);
    padding: var(--spacing-sm);
  }

  /* Hide emoji button on mobile to save space */
  #emoji-btn {
    display: none;
  }

  .message-actions {
    padding-bottom: 4px; /* Align with textarea baseline */
  }

  #send-message-btn {
    min-width: 60px;
    height: 44px;
    border-radius: var(--radius-lg);
    font-size: 1.1rem;
  }
  
  .modal-content {
    width: 95%;
    max-height: 90vh;
  }
  
  .character-card { padding: var(--spacing-md); }
  .side-panel { width: 100%; right: -100%; }
  .param-group { flex-wrap: wrap; }
  .param-group label { min-width: 100%; margin-bottom: var(--spacing-xs); }
}

/* Mobile Styles - Applied at 480px and below */
@media screen and (max-width: 480px) {
  /* Hide desktop-only elements */
  .desktop-only {
    display: none;
  }

  /* Further reduce padding and margins */
  .chat-header, .chat-input-container {
    padding: var(--spacing-xs);
  }
  
  .chat-messages {
    padding: var(--spacing-xs);
    padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
  }
  
  /* Messages take fuller width on mobile for better screen utilization */
  .message { max-width: 98% !important; }
  
  /* Make avatar smaller */
  .message .avatar, .chat-header #character-avatar { width: 32px; height: 32px; }
  
  /* Simplified buttons in chat header */
  .chat-actions {
    gap: var(--spacing-xs);
  }

  /* Compact chat input for small screens */
  .chat-input-area {
    gap: var(--spacing-xs);
    padding: var(--spacing-xs);
  }

  #message-input {
    min-height: 40px;
    max-height: 70px;
    font-size: 16px;
  }

  /* Smaller action buttons */
  .message-actions .btn.icon-btn {
    width: 40px;
    height: 40px;
    padding: 0;
  }

  #send-message-btn {
    min-width: 50px;
    height: 40px;
    padding: 0 var(--spacing-sm);
  }

  /* Removed mobile nav footer input-focused behavior */
  
  /* Modal adjustments - even more simplified */
  .modal-content {
    width: 100%;
    height: 100%;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .modal-body {
    padding: var(--spacing-sm);
  }
  
  /* Larger touch targets */
  .btn, input, select {
    min-height: 44px;
  }
  
  .btn.icon-btn {
    min-width: 44px;
  }
  
  /* Simplify settings tabs */
  .settings-tabs, .form-tabs {
    flex-wrap: wrap;
  }
    /* Emoji picker needs repositioning */
  .emoji-picker-container {
    position: fixed;
    bottom: calc(70px + env(safe-area-inset-bottom));
    left: var(--spacing-sm);
    right: var(--spacing-sm);
    width: auto;
    max-height: 250px;
    z-index: 40;
  }

  /* Better emoji picker on mobile */
  emoji-picker {
    width: 100% !important;
    height: 250px !important;
    border-radius: var(--radius-lg) !important;
    box-shadow: var(--shadow-strong) !important;
  }
}

/* ---------- Mobile-specific fixes for header / action buttons ---------- */
@media screen and (max-width: 768px), (hover: none) {
  /* Keep chat header visible while scrolling messages */
  .chat-header {
    position: sticky;
    top: 0;
    z-index: 45; /* above the fixed input (z-index:30) and dropdowns */
    /* Visual separation */
    backdrop-filter: blur(var(--blur-intensity));
  }

  /* Ensure the messages container uses native momentum scrolling on iOS */
  .chat-messages {
    -webkit-overflow-scrolling: touch;
  }

  /* On touch devices show inline actions (Edit/Delete) positioned to avoid overlaps */
  /* Hide clutter: reveal via long-press or overflow button */
  .message-inline-actions {
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-fast);
  }
  .message.message--actions-visible .message-inline-actions {
    opacity: 1;
    pointer-events: auto;
    position: absolute !important;
    top: auto !important;
    right: auto !important;
    bottom: 8px !important;
    left: 8px !important;
    background: var(--card-bg) !important;
    box-shadow: var(--shadow-soft) !important;
    padding: 4px !important;
    border-radius: var(--radius-md) !important;
    z-index: 10;
  }

  /* User messages: position on right side in free space */
  .message.user .message-inline-actions {
    left: auto !important;
    right: 8px !important;
  }

  .message-inline-actions .btn {
    min-width: 28px;
    height: 28px;
    padding: 0;
    font-size: 0.75rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    transition: all var(--transition-fast);
    box-shadow: var(--shadow-soft);
    color: var(--text-light);
  }

  /* Small per-message overflow affordance (hidden by default; revealed when active) */
  .message .message-kebab {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: var(--card-bg);
    color: var(--text-light);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-soft);
    opacity: 0; /* hidden until message toggled */
    pointer-events: none;
    transition: opacity var(--transition-fast), transform var(--transition-fast);
  }
  .message .message-kebab i { font-size: 1rem; }
  .message .message-kebab:active { opacity: 1; transform: scale(0.96); }
  .message.message--actions-visible .message-kebab { opacity: 0.85; pointer-events: auto; }
  /* Lower kebab on user messages to avoid avatar overlap */
  .message.user .message-kebab { top: 18px; }
  .message.user { position: relative; }


/* Additional mobile enhancements and overrides */
@media screen and (max-width: 768px) {
  /* Improve select / dropdown usability in modal on mobile */
  .modal select, .modal .theme-select { min-height: 48px; font-size: 1rem; line-height: 1.2; }
  .modal { overscroll-behavior: contain; }
  .modal .tab-content { -webkit-overflow-scrolling: touch; }

  /* Full-width user messages with minimal padding */
  .chat-messages .message.user .message-bubble {
    max-width: 100%;
    width: 100%;
    margin-left: 0;
    margin-right: 0;
    padding-left: 12px;
    padding-right: 48px; /* reserve space where kebab floats */
    border-top-right-radius: var(--radius-md);
  }
  .chat-messages .message.assistant .message-bubble { max-width: 100%; }
}

}
/* Mobile Portrait Orientation Adjustments */
@media screen and (max-width: 480px) and (orientation: portrait) {
  .chat-input-area {
    max-height: 100px;
  }
  
  #message-input {
    max-height: 80px;
  }
}

/* Mobile Landscape Orientation Adjustments */
@media screen and (max-height: 480px) and (orientation: landscape) {
  .chat-input-container { padding: var(--spacing-xs); }
}

/* Handle notch/dynamic island on modern mobile devices */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .chat-input-container { padding-bottom: calc(var(--spacing-sm) + env(safe-area-inset-bottom)); }
}

/* Mobile Character Selector Overlay */
.mobile-overlay {
  /* Removed legacy mobile overlay, footer nav, and tab button styles */
  overflow: hidden;
}

/* Mobile footer active state & larger send button */
.mobile-nav-footer .mobile-tab-btn.active {
  color: var(--primary-text, #fff);
  background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-medium);
  transform: translateY(-4px);
  padding: calc(var(--spacing-xs) + 4px) var(--spacing-sm);
}

/* Make send button more thumb-friendly on small phones */
@media screen and (max-width: 480px) {
  #send-message-btn {
    min-width: 64px;
    height: 48px;
    border-radius: var(--radius-lg);
    padding: 0 var(--spacing-md);
    font-size: 1rem;
  }
}

/* Hide topbar when actively chatting on mobile for more space */
@media screen and (max-width: 768px) {
  body.mobile-chat-active .sidebar {
    display: none;
  }
  
  body.mobile-chat-active .main-content {
    /* Use dvh for the outer container */
    height: 100dvh;
    height: var(--app-height, 100dvh); /* Fallback for JS */
  }
  
  body.mobile-chat-active .chat-container {
    /* Let the chat container fill its parent instead of using vh */
    height: 100%;
  }
}
